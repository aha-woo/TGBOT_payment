# é—²é±¼è®¢å•è‡ªåŠ¨è¶…æ—¶æ¸…ç†åŠŸèƒ½

## ğŸ“… æ›´æ–°æ—¥æœŸ
2025-10-27

## ğŸ¯ æ›´æ–°ç›®çš„
è§£å†³é—²é±¼è®¢å•é•¿æœŸå¤„äº `pending` çŠ¶æ€å¯¼è‡´çš„é—®é¢˜ï¼š
- âŒ ç”¨æˆ·åˆ›å»ºè®¢å•ä½†æœªå›å¡«è®¢å•å·
- âŒ å ç”¨å¾…æ”¯ä»˜è®¢å•åé¢
- âŒ è¾¾åˆ°é™åˆ¶åæ— æ³•åˆ›å»ºæ–°è®¢å•
- âŒ ç®¡ç†å‘˜æ— æ³•å®¡æ ¸æ²¡æœ‰è®¢å•å·çš„è®¢å•

## âœ¨ æ–°å¢åŠŸèƒ½

### 1. é—²é±¼è®¢å•è‡ªåŠ¨è¶…æ—¶
- â° é»˜è®¤ 30 åˆ†é’Ÿåè‡ªåŠ¨å°† `pending` çŠ¶æ€çš„é—²é±¼è®¢å•æ ‡è®°ä¸º `expired`
- ğŸ”„ è¶…æ—¶æ—¶é—´å¯é€šè¿‡ `.env` é…ç½®
- ğŸ“Š è‡ªåŠ¨é‡Šæ”¾ç”¨æˆ·çš„å¾…æ”¯ä»˜è®¢å•åé¢

### 2. åå°å®šæ—¶æ¸…ç†ä»»åŠ¡
- ğŸ§¹ æ¯ 5 åˆ†é’Ÿè‡ªåŠ¨è¿è¡Œä¸€æ¬¡æ¸…ç†ä»»åŠ¡ï¼ˆå¯é…ç½®ï¼‰
- ğŸ“ è¯¦ç»†è®°å½•æ¸…ç†æ—¥å¿—
- ğŸ›¡ï¸ çº¿ç¨‹å®‰å…¨çš„æ•°æ®åº“æ“ä½œ

### 3. å¯é…ç½®çš„è¶…æ—¶ç­–ç•¥
- âœ… USDT è®¢å•ï¼š30 åˆ†é’Ÿï¼ˆå·²æœ‰åŠŸèƒ½ï¼Œç”± tron_payment ç›‘æ§ï¼‰
- âœ… é—²é±¼è®¢å•ï¼š30 åˆ†é’Ÿï¼ˆæ–°å¢ï¼Œç”±å®šæ—¶ä»»åŠ¡æ¸…ç†ï¼‰
- âœ… æ¸…ç†é—´éš”ï¼š5 åˆ†é’Ÿï¼ˆå¯è°ƒæ•´ï¼‰

## ğŸ“ é…ç½®è¯´æ˜

### åœ¨ `.env` æ–‡ä»¶ä¸­æ·»åŠ ä»¥ä¸‹é…ç½®ï¼š

```env
# è®¢å•è¶…æ—¶è®¾ç½®
ORDER_TIMEOUT_MINUTES=30              # USDTè®¢å•è¶…æ—¶æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰
XIANYU_ORDER_TIMEOUT_MINUTES=30       # é—²é±¼è®¢å•è¶…æ—¶æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰
ORDER_CLEANUP_INTERVAL_MINUTES=5      # è®¢å•æ¸…ç†ä»»åŠ¡è¿è¡Œé—´éš”ï¼ˆåˆ†é’Ÿï¼‰

# é˜²åˆ·é…ç½®
MAX_PENDING_ORDERS_PER_USER=3         # æ¯ä¸ªç”¨æˆ·æœ€å¤šåŒæ—¶å¾…æ”¯ä»˜è®¢å•æ•°
MIN_ORDER_INTERVAL_SECONDS=60         # ä¸‹å•æœ€å°é—´éš”ï¼ˆç§’ï¼‰
```

### é…ç½®é¡¹è¯´æ˜

| é…ç½®é¡¹ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|--------|------|
| `ORDER_TIMEOUT_MINUTES` | 30 | USDTè®¢å•è¶…æ—¶æ—¶é—´ |
| `XIANYU_ORDER_TIMEOUT_MINUTES` | 30 | é—²é±¼è®¢å•è¶…æ—¶æ—¶é—´ |
| `ORDER_CLEANUP_INTERVAL_MINUTES` | 5 | æ¸…ç†ä»»åŠ¡è¿è¡Œé—´éš” |
| `MAX_PENDING_ORDERS_PER_USER` | 3 | æ¯ä¸ªç”¨æˆ·æœ€å¤šå¾…æ”¯ä»˜è®¢å•æ•° |
| `MIN_ORDER_INTERVAL_SECONDS` | 60 | ä¸‹å•æœ€å°é—´éš” |

## ğŸ”§ æŠ€æœ¯å®ç°

### 1. é…ç½®æ–‡ä»¶ä¿®æ”¹ (`config.py`)
```python
# æ–°å¢é…ç½®é¡¹
XIANYU_ORDER_TIMEOUT_MINUTES = int(os.getenv('XIANYU_ORDER_TIMEOUT_MINUTES', '30'))
ORDER_CLEANUP_INTERVAL_MINUTES = int(os.getenv('ORDER_CLEANUP_INTERVAL_MINUTES', '5'))
```

### 2. æ•°æ®åº“æ–¹æ³• (`database.py`)
```python
def cleanup_expired_xianyu_orders(self, timeout_minutes: int) -> int:
    """
    æ¸…ç†è¿‡æœŸçš„é—²é±¼å¾…æ”¯ä»˜è®¢å•
    
    Args:
        timeout_minutes: è¶…æ—¶æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰
        
    Returns:
        æ¸…ç†çš„è®¢å•æ•°é‡
    """
    # æŸ¥æ‰¾å¹¶æ›´æ–°è¿‡æœŸè®¢å•ä¸º expired çŠ¶æ€
    # è¿”å›æ¸…ç†æ•°é‡
```

### 3. å®šæ—¶ä»»åŠ¡ (`bot.py`)
```python
async def cleanup_expired_orders(context: ContextTypes.DEFAULT_TYPE):
    """å®šæœŸæ¸…ç†è¿‡æœŸçš„é—²é±¼è®¢å•"""
    cleaned_count = db.cleanup_expired_xianyu_orders(XIANYU_ORDER_TIMEOUT_MINUTES)
    if cleaned_count > 0:
        logger.info(f"ğŸ§¹ Auto-cleanup: {cleaned_count} xianyu order(s) expired")

# æ³¨å†Œå®šæ—¶ä»»åŠ¡
application.job_queue.run_repeating(
    cleanup_expired_orders,
    interval=ORDER_CLEANUP_INTERVAL_MINUTES * 60,
    first=30  # å¯åŠ¨å30ç§’å¼€å§‹
)
```

## ğŸ“Š å·¥ä½œæµç¨‹

```
ç”¨æˆ·åˆ›å»ºé—²é±¼è®¢å•
    â†“
çŠ¶æ€: pending
    â†“
åå°å®šæ—¶ä»»åŠ¡ (æ¯5åˆ†é’Ÿ)
    â†“
æ£€æŸ¥: created_at < (now - 30åˆ†é’Ÿ)
    â†“
æ˜¯ â†’ æ›´æ–°çŠ¶æ€ä¸º expired
    â†“
é‡Šæ”¾å¾…æ”¯ä»˜è®¢å•åé¢
    â†“
ç”¨æˆ·å¯ä»¥åˆ›å»ºæ–°è®¢å•
```

## ğŸ‰ é¢„æœŸæ•ˆæœ

### ç”¨æˆ·ä½“éªŒæ”¹å–„
- âœ… ä¸å†å› æ—§è®¢å•å †ç§¯è€Œæ— æ³•åˆ›å»ºæ–°è®¢å•
- âœ… æ›´æ¸…æ™°çš„è®¢å•çŠ¶æ€æç¤º
- âœ… è‡ªåŠ¨æ¸…ç†è¿‡æœŸè®¢å•ï¼Œæ— éœ€æ‰‹åŠ¨å¹²é¢„

### ç®¡ç†å‘˜ä½“éªŒæ”¹å–„
- âœ… å‡å°‘æ— æ•ˆçš„å¾…å®¡æ ¸è®¢å•
- âœ… æ›´å‡†ç¡®çš„è®¢å•ç»Ÿè®¡æ•°æ®
- âœ… ç³»ç»Ÿè‡ªåŠ¨ç»´æŠ¤ï¼Œé™ä½ç®¡ç†æˆæœ¬

### ç³»ç»Ÿç¨³å®šæ€§æå‡
- âœ… é˜²æ­¢è®¢å•è¡¨æ— é™å¢é•¿
- âœ… æœ‰æ•ˆçš„é˜²åˆ·å•æœºåˆ¶
- âœ… è‡ªåŠ¨åŒ–çš„è®¢å•ç”Ÿå‘½å‘¨æœŸç®¡ç†

## ğŸ“ æ—¥å¿—ç¤ºä¾‹

### æ­£å¸¸æ¸…ç†æ—¥å¿—
```
2025-10-27 10:05:30 - database - INFO - Cleaned up 3 expired xianyu orders (timeout: 30 min)
2025-10-27 10:05:30 - database - DEBUG -   - Order XY_8068014765_1730023456789 (user 8068014765) expired
2025-10-27 10:05:30 - database - DEBUG -   - Order XY_8068014765_1730023567890 (user 8068014765) expired
2025-10-27 10:05:30 - database - DEBUG -   - Order XY_8068014765_1730023678901 (user 8068014765) expired
2025-10-27 10:05:30 - __main__ - INFO - ğŸ§¹ Auto-cleanup: 3 xianyu order(s) expired and cleaned up
```

### æ— è¿‡æœŸè®¢å•
```
2025-10-27 10:10:30 - database - INFO - Cleaned up 0 expired xianyu orders (timeout: 30 min)
```

## ğŸ” æµ‹è¯•éªŒè¯

### æµ‹è¯•æ­¥éª¤
1. åˆ›å»ºé—²é±¼è®¢å•ä½†ä¸å›å¡«è®¢å•å·
2. ç­‰å¾…è¶…æ—¶æ—¶é—´ï¼ˆé»˜è®¤30åˆ†é’Ÿï¼‰
3. è§‚å¯Ÿæ—¥å¿—ï¼Œç¡®è®¤è®¢å•è¢«è‡ªåŠ¨æ¸…ç†
4. éªŒè¯å¯ä»¥åˆ›å»ºæ–°è®¢å•

### å¿«é€Ÿæµ‹è¯•ï¼ˆä¸´æ—¶ä¿®æ”¹ï¼‰
åœ¨ `.env` ä¸­è®¾ç½®ï¼š
```env
XIANYU_ORDER_TIMEOUT_MINUTES=1        # 1åˆ†é’Ÿè¶…æ—¶
ORDER_CLEANUP_INTERVAL_MINUTES=1      # 1åˆ†é’Ÿè¿è¡Œä¸€æ¬¡
```

æµ‹è¯•å®Œæˆåæ”¹å›ç”Ÿäº§ç¯å¢ƒé…ç½®ã€‚

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **è®¢å•è¶…æ—¶æ—¶é—´å»ºè®®**
   - æµ‹è¯•ç¯å¢ƒï¼š1-5 åˆ†é’Ÿï¼ˆå¿«é€ŸéªŒè¯ï¼‰
   - ç”Ÿäº§ç¯å¢ƒï¼š30-60 åˆ†é’Ÿï¼ˆç»™ç”¨æˆ·å……è¶³æ—¶é—´ï¼‰

2. **æ¸…ç†é—´éš”å»ºè®®**
   - æµ‹è¯•ç¯å¢ƒï¼š1 åˆ†é’Ÿ
   - ç”Ÿäº§ç¯å¢ƒï¼š5-10 åˆ†é’Ÿ

3. **é˜²åˆ·é…ç½®å»ºè®®**
   - `MAX_PENDING_ORDERS_PER_USER`: 3-5 ä¸ª
   - `MIN_ORDER_INTERVAL_SECONDS`: 60-120 ç§’

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1. æ›´æ–°ä»£ç 
```bash
git pull
```

### 2. æ›´æ–° `.env` é…ç½®
æ·»åŠ ä¸Šè¿°é…ç½®é¡¹ï¼ˆå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤å€¼ï¼‰

### 3. é‡å¯ Bot
```bash
# ä½¿ç”¨ PM2
pm2 restart payment-bot

# æˆ–ç›´æ¥è¿è¡Œ
python3 bot.py
```

### 4. éªŒè¯å¯åŠ¨
æŸ¥çœ‹æ—¥å¿—ç¡®è®¤æ¸…ç†ä»»åŠ¡å·²å¯åŠ¨ï¼š
```bash
pm2 logs payment-bot
```

åº”è¯¥çœ‹åˆ°ï¼š
```
Order cleanup task started (running every 5 minutes)
```

## ğŸ“š ç›¸å…³æ–‡æ¡£
- `README.md` - å®Œæ•´åŠŸèƒ½è¯´æ˜
- `QUICKSTART.md` - å¿«é€Ÿå¼€å§‹æŒ‡å—
- `CONFIG_GUIDE.md` - é…ç½®æŒ‡å—

## âœ… å®Œæˆæ¸…å•
- [x] æ·»åŠ é—²é±¼è®¢å•è¶…æ—¶é…ç½®
- [x] å®ç°æ•°æ®åº“æ¸…ç†æ–¹æ³•
- [x] æ·»åŠ å®šæ—¶æ¸…ç†ä»»åŠ¡
- [x] æ›´æ–°æ–‡æ¡£å’Œé…ç½®è¯´æ˜
- [x] æ·»åŠ è¯¦ç»†æ—¥å¿—è®°å½•
- [x] ä¿®å¤å¯¼å…¥é”™è¯¯

## ğŸ¯ åç»­ä¼˜åŒ–å»ºè®®

1. **ç”¨æˆ·é€šçŸ¥**
   - è®¢å•å³å°†è¿‡æœŸæ—¶å‘é€æé†’ï¼ˆä¾‹å¦‚å‰©ä½™5åˆ†é’Ÿï¼‰
   - è®¢å•è¿‡æœŸåå‘é€é€šçŸ¥

2. **ç®¡ç†å‘˜ç»Ÿè®¡**
   - æ¯æ—¥è¿‡æœŸè®¢å•ç»Ÿè®¡
   - è®¢å•è½¬åŒ–ç‡åˆ†æ

3. **çµæ´»çš„è¶…æ—¶ç­–ç•¥**
   - æ ¹æ®å¥—é¤ç±»å‹è®¾ç½®ä¸åŒè¶…æ—¶æ—¶é—´
   - VIPç”¨æˆ·å»¶é•¿è¶…æ—¶æ—¶é—´

4. **è®¢å•æ¢å¤æœºåˆ¶**
   - å…è®¸ç”¨æˆ·ç”³è¯·æ¢å¤è¿‡æœŸè®¢å•
   - ç®¡ç†å‘˜å¯æ‰‹åŠ¨æ¢å¤è®¢å•

---

ğŸ’¡ **æç¤º**: å¦‚æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶ `bot.log` æˆ–ä½¿ç”¨ `pm2 logs payment-bot` æŸ¥çœ‹å®æ—¶æ—¥å¿—ã€‚

